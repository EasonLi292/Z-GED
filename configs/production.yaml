# Configuration for Latent-Guided GraphGPT Circuit Decoder Training
#
# Architecture:
# - Decoder generates circuit graphs (nodes + edges + values)
# - No pole/zero prediction (evaluated via SPICE simulation)
# - Latent-guided edge generation with cross-attention
#
# Key innovations:
# 1. Cross-attention to latent at each edge decision
# 2. TF consistency scoring for smart edge selection
# 3. Iterative edge refinement (3 iterations)
# 4. Smart VIN connectivity enforcement

# Model Architecture
model:
  # Encoder (will be loaded from pretrained checkpoint)
  encoder:
    node_feature_dim: 4
    edge_feature_dim: 7
    gnn_hidden_dim: 64
    gnn_num_layers: 3
    latent_dim: 8
    topo_latent_dim: 2
    values_latent_dim: 2
    pz_latent_dim: 4
    dropout: 0.1

  # Latent-Guided GraphGPT Decoder (no TF prediction)
  decoder:
    latent_dim: 8                # Latent code dimension from encoder
    conditions_dim: 2            # Specifications dimension (cutoff, Q)
    hidden_dim: 256              # Hidden dimension for transformer
    num_heads: 8                 # Number of attention heads
    num_node_layers: 4           # Number of transformer layers for nodes
    max_nodes: 5                 # Maximum number of nodes
    dropout: 0.1                 # Dropout probability

    # Latent-guided parameters
    num_edge_iterations: 3       # Iterative edge refinement (3 iterations)
    enforce_vin_connectivity: true  # Smart VIN connectivity enforcement
    consistency_boost: 1.5       # Boost factor for high-consistency edges (>0.7)
    consistency_penalty: 0.5     # Penalty factor for low-consistency edges (<0.3)

# Training Configuration
training:
  # Two-phase training
  phase1_epochs: 100             # Freeze encoder, train decoder only
  phase2_epochs: 100             # Joint fine-tuning
  total_epochs: 200              # Total training epochs

  batch_size: 4                  # Batch size
  learning_rate_phase1: 1.0e-4   # Learning rate for phase 1 (decoder only)
  learning_rate_phase2: 5.0e-5   # Learning rate for phase 2 (joint)

  weight_decay: 1.0e-5           # L2 regularization
  grad_clip: 1.0                 # Gradient clipping

  kl_weight: 0.01                # KL divergence weight (phase 2 only)

# Loss Weights (no TF prediction - evaluated via SPICE)
loss:
  # Circuit generation losses
  node_type_weight: 1.0          # Node type prediction
  edge_exist_weight: 1.0         # Edge existence prediction
  edge_value_weight: 1.0         # Edge value prediction (R, C, L)

  # Latent-guided parameters
  consistency_weighting_strength: 2.0  # Strength of TF consistency weighting (for edge guidance)

  # Connectivity loss
  use_connectivity_loss: true    # Enable connectivity loss
  connectivity_weight: 5.0       # Weight for connectivity loss (VIN/VOUT)

# Edge Generation Monitoring
edge_monitoring:
  enabled: false                 # Disabled to avoid dependency
  warning_threshold: 0.3         # Warn if mean edge prob < this
  critical_threshold: 0.1        # Critical alert if mean edge prob < this
  check_every_n_batches: 10      # Check edge stats every N batches

# Data Configuration
data:
  dataset_path: 'rlc_dataset/filter_dataset.pkl'
  train_split: 0.8               # 80% training, 20% validation

# Checkpoint Configuration
checkpoint:
  pretrained_encoder: null       # Train from scratch with new normalization
  save_dir: 'checkpoints/latent_guided_decoder'
  save_frequency: 10             # Save checkpoint every N epochs
  keep_best: true                # Keep best validation loss checkpoint

# Validation Configuration
validation:
  frequency: 1                   # Validate every N epochs
  num_samples: 10                # Number of samples to generate for visualization

# Logging Configuration
logging:
  log_frequency: 10              # Log metrics every N batches
  tensorboard: false             # Use TensorBoard logging
  verbose: true                  # Print detailed metrics

  # NEW: Latent-guided specific logging
  log_consistency_scores: true   # Log consistency score distribution
  log_vin_connectivity: true     # Log VIN connectivity rate during training
